name: Spring Boot CI/CD - Graceful Restart

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      #  拉取项目代码
      - name: Checkout
        uses: actions/checkout@v4

      #  安装 JDK
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven

      # 编译打包
      - name: Build with Maven
        run: mvn clean package

      # 创建待上传文件夹并复制文件
      - name: Prepare files for upload
        run: |          
          mkdir -p upload
          cp entrance/target/entrance*.jar upload/
          cp entrance/src/main/resources/application-prod.yaml upload/
          cp restart.sh upload/

      # 上传文件到服务器
      - name: Upload file via SSH
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "upload/*"
          target: ${{ secrets.SERVER_PROJECT_PATH }}

      # 执行 restart.sh
      - name: perform restart.sh
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.SERVER_PROJECT_PATH }}
            chmod 755 restart.sh
            # 获取最新 jar 文件名
            LATEST_JAR=$(ls -t *.jar | head -n 1)
            echo "最新 jar 包：$LATEST_JAR"
            
            # 更新 APP_NAME、SERVER_PROJECT_PATH 到 restart.sh 中
            sed -i "s/^APP_NAME=.*/APP_NAME=\"$LATEST_JAR\"/" restart.sh
            sed -i "s|^APP_PATH=.*|APP_PATH=\"${{ secrets.SERVER_PROJECT_PATH }}\"|" restart.sh
            
            echo "执行重启脚本..."
            bash -l restart.sh