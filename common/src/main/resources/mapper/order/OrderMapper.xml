<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ligg.common.mapper.order.OrderMapper">

    <!--订单详情映射结构-->
    <resultMap id="OrderInfoMap" type="com.ligg.common.module.vo.OrderInfoVo">
        <id property="orderNo" column="order_no"/>
        <result property="userId" column="user_id"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="payType" column="pay_type"/>
        <result property="addressId" column="address_id"/>
        <result property="remark" column="remark"/>
        <result property="status" column="status"/>
        <result property="quantity" column="quantity"/>
        <result property="createTime" column="create_time"/>
        <result property="payTime" column="pay_time"/>
        <association property="address" javaType="com.ligg.common.module.vo.OrderInfoVo$Address">
            <id property="id" column="id"/>
            <result property="receiverName" column="receiver_name"/>
            <result property="receiverPhone" column="receiver_phone"/>
            <result property="province" column="province"/>
            <result property="city" column="city"/>
            <result property="district" column="district"/>
            <result property="detailAddress" column="detail_address"/>
        </association>
        <association property="product" javaType="com.ligg.common.module.vo.OrderInfoVo$Product">
            <id property="id" column="productId"/>
            <result property="title" column="title"/>
            <result property="image" column="image"/>
        </association>
    </resultMap>

    <!-- 查询订单信息 -->
    <select id="selectOrderByOrderNo" resultMap="OrderInfoMap">
        select o.order_no,
               o.user_id,
               o.total_amount,
               o.pay_type,
               o.address_id,
               o.remark,
               o.status,
               o.create_time,
               oi.quantity,
               oi.product_id,
               ua.id,
               ua.receiver_name,
               ua.receiver_phone,
               ua.province,
               ua.city,
               ua.district,
               ua.detail_address,
               p.id         as productId,
               p.title,
               p.image_path as image
        from orders o
                 left join order_item oi on o.id = oi.order_id
                 left join user_address ua on o.address_id = ua.id
                 left join product p on oi.product_id = p.id
        where o.order_no = #{orderNo}
    </select>

    <!-- 订单规格列表-->
    <select id="selectOrderItemSpecListByOrderNo" resultType="com.ligg.common.module.vo.OrderInfoVo$SpecValue">
        select psv.id,
               psv.value
        from orders o
                 left join order_item oi on o.id = oi.order_id
                 left join order_item_spec ois on oi.id = ois.order_item_id
                 left join product_spec_value psv on ois.spec_value_id = psv.id
        where o.order_no = #{orderNo}
    </select>

    <!-- 订单列表-->
    <select id="selectOrderListByUserId" resultType="com.ligg.common.module.vo.OrderVo">
        SELECT ord.id,
        ord.order_no,
        ord.total_amount,
        ord.pay_type,
        ord.status,
        ord.address_id,
        ord.remark,
        ord.create_time,
        ord.pay_time,
        oi.quantity,
        p.image_path AS image,
        p.title
        FROM orders ord
        LEFT JOIN order_item oi ON ord.id = oi.order_id
        LEFT JOIN product p ON oi.product_id = p.id
        WHERE ord.user_id = #{userId}
        <if test="keyword != null and keyword != ''">
            AND (p.title LIKE CONCAT('%', #{keyword}, '%') OR ord.order_no LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="status != null">
            AND ord.status = #{status.code}
        </if>
        ORDER BY ord.create_time DESC
    </select>
</mapper>
